# 06_コンテナセキュリティ入門 🛡️🐳

Dockerコンテナは「隔離されているから安全」だと過信していませんか？
設定をミスれば、コンテナ経由でホストPC（サーバー）を乗っ取ることが可能です。

## 1. 原則: Rootで動かすな
Dockerfile で何も指定しないと、コンテナ内のプロセスは `root` 権限で動きます。
もしアプリに脆弱性があって侵入されると、攻撃者はコンテナ内で `root` を奪取します。

### 対策: USER 命令
Dockerfile内で、権限の低いユーザーを作って切り替えます。
```dockerfile
RUN groupadd -r app && useradd -r -g app app
USER app
CMD ["./main"]
```

## 2. イメージの脆弱性スキャン
ベースイメージ（`node:14` や `ubuntu:20.04`）自体に既知の脆弱性が含まれていることがあります。
Trivy などのスキャナを使って、ビルド時にチェックしましょう。

```bash
trivy image my-app:latest
```

## 3. シークレットの管理
環境変数 (`ENV API_KEY=...`) にパスワードを書いてはいけません。
`docker inspect` コマンドで誰でも見れてしまいます。
クラウドの Secret Manager や、K8s の Secrets 機能を使って、実行時にファイルとしてマウントするのが安全です。

## 4. Immutable Infrastructure
「起動中のコンテナに入って設定ファイルを書き換える」のはやめましょう。
それは「セキュリティパッチが当たっていないゾンビコンテナ」を生み出す原因です。
変更が必要なら、**新しいイメージをビルドして、コンテナごと入れ替える**。
これが不変（Immutable）の原則です。これにより、常にクリーンで追跡可能な状態が保たれます。

---

## 📚 用語集 (Glossary)

| 用語 | 意味 | 補足 |
|------|------|-----|
| **Root (ルート)** | 特権ユーザー | 何でもできる神。セキュリティリスク大。 |
| **Vulnerability** | 脆弱性 (ぜいじゃくせい) | セキュリティの穴。バグ。 |
| **Secret** | 秘密情報 | パスワードやAPIキーなど。 |
| **Immutable** | 不変の | 一度作ったら変更しないこと。 |
| **Least Privilege** | 最小権限の原則 | 必要なこと以外させない。 |

## 🛠️ コマンド集 (Security Tools)

| コマンド | 説明 |
|---|---|
| `trivy image [name]` | イメージの脆弱性をスキャンする |
| `docker inspect [name]` | コンテナの詳細を表示（環境変数丸見え注意） |
| `docker history [image]` | イメージがどう作られたか確認する |
