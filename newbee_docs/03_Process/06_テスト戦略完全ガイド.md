# 17_テスト戦略完全ガイド 🧪

「修正したら別の場所が壊れた」を防ぐ唯一の手段。
全ての行をテストするのはコストがかかりすぎます。**ピラミッド戦略** で効率よく品質を担保しましょう。

## 1. テストのピラミッド

### Unit Test (単体テスト) - 土台 70%
- **対象**: 関数、クラス単体 (`VideoService.upload` など)。Flutterに依存しないロジック。
- **特徴**: 爆速。一瞬で終わる。
- **書き方**: モック (Mock) を多用し、外部要因（DBやネットワーク）を排除してロジックだけ検証する。

### Widget Test (コンポーネントテスト) - 中層 20%
- **対象**: UIパーツ (`auth_screen` など)。
- **特徴**: Flutterフレームワークを使うが、エミュレータは起動しない（ヘッドレス）。そこそこ速い。
- **検証**: 「ボタンを押したらローディングが出るか」「テキストが正しく表示されるか」。

### Integration Test (統合/E2Eテスト) - 頂上 10%
- **対象**: アプリ全体。実際のデバイスやシミュレータで動かす。
- **特徴**: 遅い。壊れやすい。セットアップが大変。
- **検証**: 「ログインして、撮影して、アップロード完了するまで」の一連のフロー。ハッピーパス（主要導線）のみに絞るのがコツ。

## 2. Golden Test (VRT - Visual Regression Test)
「レイアウト崩れ」を検知するテストです。
Widget のスクリーンショット（マスター画像）を保存しておき、テスト実行時の見た目がマスターと 1ピクセルでも違えばエラーにします。
デザインの意図しない変更を機械的に検出できる強力な手法です。

## 3. TDD (Test Driven Development)
「テストコードを先に書く」開発手法です。
1. **Red**: 失敗するテストを書く（まだ機能がないから）。
2. **Green**: テストを通すための最小限の実装を書く。
3. **Refactor**: きれいにする。

必ずしも全員がやる必要はありませんが、「テストしやすいコード（疎結合なコード）」を書く強制力が働きます。

## 4. テスト容易性 (Testability)
「テストが書きにくいコード」は、たいてい設計が悪いです。
- グローバル変数に依存している。
- クラスの中で `new` している（DIしていない）。
- 一つのメソッドが長すぎる。

テストを書くことは、設計の健康診断でもあります。

---

## 📚 用語集 (Glossary)

| 用語 | 意味 | 補足 |
|------|------|-----|
| **Unit Test** | 単体テスト | 一番細かいテスト |
| **Integration Test** | 統合テスト | 全体が繋がっているかのテスト |
| **Mock (モック)** | 偽物・身代わり | 実際のDBやAPIの代わりにする |
| **Coverage (カバレッジ)** | 網羅率 | コードの何%をテストしたか |
| **Golden Test** | スナップショットテスト | 画像比較でズレを検知 |
| **Regression (リグレッション)** | 先祖返り・退行 | 直したはずがまた壊れること |

