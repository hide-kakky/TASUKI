# 13. テストと環境分離（発展編）

## 🎯 このレッスンで学ぶこと

- なぜデータベースを分ける必要があるのか？
- 本番環境（Production）と開発環境（Development）
- テスト時の「認証の壁」をどう乗り越えるか
- Supabase CLI を使ったローカル開発

---

## 1. データベースは分けるべき？

**結論：絶対に分けるべきです！** 🛡️

### 理由1: データを壊すリスク
開発中は、「データを全部消してやり直したい」ことがよくあります。
もし本番DB（実際のお客様がいるDB）でこれをやったら... **大事故**です😱

### 理由2: スキーマ変更のリスク
「新しいテーブルを追加したい」「カラム名を変えたい」
開発環境なら自由に試せますが、本番環境でいきなりやるとアプリが動かなくなる可能性があります。

### TASUKIの推奨構成

```
【Production（本番）】
- 実際のユーザーが使う
- Supabaseクラウド上のプロジェクトA
- データは絶対に消さない

【Staging / Development（開発）】
- 開発者が使う
- Supabaseクラウド上のプロジェクトB（またはローカル）
- データはいつでも消してOK
```

Flutterアプリ側では、`.env` ファイルを切り替えることで接続先を変えます。

## 2. テスト時の「認証の壁」

TASUKIは **マジックリンク認証**（メールでログイン）を採用しています。
これはセキュリティが高いですが、自動テスト（E2Eテスト）をする時には**壁**になります。

### 問題点
テストプログラム「ログインしたい！」
↓
Supabase「メール送ったよ。リンク踏んでね」
↓
テストプログラム「...メールボックス見れないよ😭」

### 解決策: Supabase CLI（ローカル開発）を使う

Supabaseには、自分のパソコンの中に**偽物のSupabase**を立ち上げる機能があります。

```bash
supabase start
```

これを使うと、送信されたメールは**Inbucket**という仮想メールボックスに溜まります。

#### テストの流れ（ローカル）

1. **テストコード**: ログインリクエストを送る
2. **Supabase (Local)**: メールを送信（実際には飛ばず、Inbucketに入る）
3. **テストコード**: InbucketのAPIを叩いて、「最新のメールのリンク」を取得
4. **テストコード**: そのリンクにアクセスしてログイン完了！✅

これなら、実際のメールアドレスを使わずに何度でもテストできます。

---

## 3. 具体的なテスト設計

### ユーザーの準備（Seedデータ）

テストのたびにユーザー登録するのは大変なので、**Seed（シード）データ**を使います。
「最初から入っているテスト用データ」のことです。

```sql
-- supabase/seed.sql
INSERT INTO public.users (id, display_name) VALUES ('test-user-id', 'テスト太郎');
```

### 認証をバイパスする裏技（開発環境のみ）

開発環境限定で、**「特定のメールアドレスならパスワードでログインできるようにする」** という設定も可能です。

```dart
// テストコード
if (Env.isTest) {
  await supabase.auth.signInWithPassword(
    email: 'test@example.com',
    password: 'password123', // テスト用ユーザーだけパスワード設定しておく
  );
}
```
※ 本番環境では絶対にやってはいけません！

---

## 📚 用語集 (Glossary)

| 用語 | 意味 | 関連 |
|------|------|-----|
| **Production (Prod)** | 本番環境 | 絶対に壊してはいけない |
| **Development (Dev)** | 開発環境 | 壊しても怒られない |
| **Local Environment** | 自分のPC内環境 | 自分しか見れない |
| **Seed Data** | 初期投入データ | テスト用のダミーデータなど |
| **Inbucket** | 仮想メールボックス | ローカル開発でメールを確認するツール |
| **Environment Variable** | 環境変数 | `.env` ファイルなど |

## 🛠️ コマンド集 (Supabase Local)

| コマンド | 説明 |
|---|---|
| `supabase start` | ローカルSupabaseを起動 |
| `supabase stop` | 停止 |
| `supabase status` | ポート番号やキーを表示 |
| `supabase db reset` | DBを全消去してマイグレーションとSeedを再実行 |

---

## 📝 まとめ

1. **DBは必ず分ける**: 本番データを守るため、ProductionとDevelopmentは別のプロジェクトにする。
2. **ローカル開発を活用**: `supabase start` でローカル環境を作ると、開発もテストも安全・高速。
3. **テスト時の認証**: ローカル環境のInbucketを使うか、テスト用ユーザーを用意して解決する。

テスト環境を整えるのは最初は面倒ですが、**「安心して壊せる環境」**があると、開発スピードは劇的に上がります！🚀
