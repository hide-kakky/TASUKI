# 09_認証と認可の仕組み 🔐

「ログイン機能」の裏側で何が起きているのか？
セキュリティの基本コンセプトである **AuthN (認証)** と **AuthZ (認可)** を理解しましょう。

## 1. 認証 (Authentication / AuthN)
**「あなたは誰ですか？」** を確認すること。
- パスワード認証: 「秘密の言葉を知っているから本人だ」
- 生体認証: 「指紋が一致するから本人だ」
- 多要素認証 (MFA): 「パスワードも知っていて、スマホも持っているから本人だ」

TASUKI では **Magic Link** (メールに届いたURLをクリック) を使っています。
「メールボックスにアクセスできる = 本人」という証明方法です。

## 2. 認可 (Authorization / AuthZ)
**「あなたは何をしていいですか？」** を確認すること。
- 「あなたは田中さんですね（認証OK）。でも、管理者ページを見る権限はありません（認可NG）」

TASUKI では Supabase の **RLS (Row Level Security)** でこれを制御しています。
「`store_id` が自分の所属と同じデータしか見られない」というのは認可のルールです。

## 3. セッションとトークン (JWT)
ログインした後、毎回パスワードを入力するのは面倒です。
そこで、サーバーは「通行手形」を発行します。これが **Access Token** です。

### JWT (JSON Web Token)
今の主流です。「ジョット」と呼びます。
トークンの中に「ユーザーID」や「有効期限」が暗号化されて埋め込まれています。

1. **ログイン**: メールリンクを踏む。
2. **トークン発行**: Supabase が JWT をアプリに返す。
3. **アクセス**: アプリは API を叩くたびに、ヘッダーに `Authorization: Bearer <JWT>` をつけて送る。
4. **検証**: Supabase は JWT を見て「あ、これは田中さんのリクエストだな」と判断する。

### 注意点
JWT が盗まれると、他人があなたになりすまして操作できてしまいます。
- **HTTPS 必須**: 通信を暗号化して盗聴を防ぐ。
- **有効期限**: 万が一盗まれても、数時間で無効になるようにする（Refresh Token で更新する）。
