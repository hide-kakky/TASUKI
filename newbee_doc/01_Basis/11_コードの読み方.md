# 11. コードの読み方

## 🎯 このレッスンで学ぶこと

- プロジェクトのフォルダ構成
- Flutterコードの読み方
- Edge Functionsコードの読み方
- どこから読み始めるべきか

---

## 1. フォルダ構成を理解する

TASUKIのプロジェクトは、大きく3つの場所に分かれています。

```
TASUKI/
├── apps/
│   ├── app/           ← 📱 Flutterアプリ（フロントエンド）
│   └── edge/          ← 🔧 Edge Functions（バックエンド処理）
├── supabase/          ← 💾 データベース設定
│   ├── migrations/    ← テーブル定義
│   └── seed.sql       ← テストデータ
└── docs/              ← 📚 ドキュメント（これ！）
```

### 迷ったらここを見る

- **画面のコードが見たい** → `apps/app/lib/`
- **サーバーの処理が見たい** → `apps/edge/supabase/functions/`
- **データベースの構造が見たい** → `supabase/migrations/`

---

## 2. Flutterコードの読み方

Flutterのコード（Dartファイル）は、だいたいこの構成です。

```dart
// 1. インポート（必要な道具を揃える）
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';

// 2. クラス定義（画面や部品を作る）
class MyScreen extends ConsumerWidget {
  const MyScreen({super.key});

  // 3. buildメソッド（画面を描画する）
  @override
  Widget build(BuildContext context, WidgetRef ref) {
    // 4. ロジック（変数を準備したり）
    final user = ref.watch(userProvider);

    // 5. UIを返す（ウィジェットを組み立てる）
    return Scaffold(
      appBar: AppBar(title: Text('TASUKI')),
      body: Center(
        child: Text('こんにちは、${user.name}さん'),
      ),
    );
  }
}
```

### 読むコツ
1. **`build` メソッドを探す**: ここに「何が表示されるか」が書いてあります。
2. **`return` の中を見る**: 画面の構造（AppBarがあって、真ん中にTextがあって...）がわかります。
3. **`ref.watch` を探す**: どんなデータ（状態）を使っているかがわかります。

---

## 3. Edge Functionsコードの読み方

Edge Functions（TypeScriptファイル）は、もっとシンプルです。

```typescript
// 1. サーバーの準備
import { serve } from "https://deno.land/std/http/server.ts";

// 2. リクエストを受け取る
serve(async (req) => {
  try {
    // 3. データを取得
    const { name } = await req.json();

    // 4. 何か処理をする（DB保存やAI呼び出し）
    const message = `こんにちは、${name}さん`;

    // 5. レスポンスを返す
    return new Response(
      JSON.stringify({ message }),
      { headers: { "Content-Type": "application/json" } },
    );

  } catch (error) {
    // エラー処理
    return new Response(error.message, { status: 500 });
  }
});
```

### 読むコツ
1. **`serve` の中を見る**: ここが処理の本体です。
2. **`req.json()` を探す**: クライアントから何が送られてきたかがわかります。
3. **`return new Response` を探す**: 最終的に何を返しているかがわかります。

---

## 4. どこから読み始める？

いきなり全部読むのは無理です。**「機能」**単位で読みましょう。

### 例：「録画機能」を知りたい場合

1. **画面を探す**: `apps/app/lib/features/flow/record_screen.dart`
   - 「録画ボタン」を押したら何が起きる？
   - `uploadVideo()` という関数を呼んでいるな...

2. **ロジックを追う**: `apps/app/lib/features/flow/upload_service.dart`
   - `uploadVideo()` の中身を見る
   - Muxにアップロードしているな...

3. **サーバー処理を見る**: `apps/edge/supabase/functions/mux_webhook/index.ts`
   - アップロード完了通知を受け取って何をしている？
   - DBを更新しているな...

**「点」ではなく「線」で追う** のがコツです！

---

## 📝 まとめ

- フォルダ構成：`apps/app`（スマホ）、`apps/edge`（サーバー）、`supabase`（DB）
- Flutter：`build` メソッドの中に画面の設計図がある
- Edge Functions：`serve` の中に処理の流れがある
- 機能単位で「線」で追うと理解しやすい

---

次は最後のレッスン「12_実装の流れ.md」です！
