# 05_Flutterパフォーマンス最適化 🚀

「なんとなく遅い」を「科学的に速い」に変える技術。
推測でチューニングしてはいけません。必ず計測しましょう。

## 1. DevTools の活用
Flutter には強力なプロファイリングツールがついています。

- **Flutter Inspector**: Widgetツリーを可視化。無駄に深いネストがないか確認。
- **Performance View**:
  - **Frame Rendering Chart**: 棒グラフが赤い場合、1フレームの描画が16ms (60fps) に間に合っていません。
  - **Jank (カクつき)**: 重い処理がUIスレッドをブロックした時に起きます。

## 2. ビルド回数の削減
`build()` メソッドは何度も走ります。ここに重い処理を書かないのはもちろん、**再ビルドの範囲を狭める** ことが重要です。

- **`const` コンストラクタ**:
  - `const Text('Hello')` と書くと、Flutterは「これは一生変わらない」と判断し、再利用します。
- **範囲を区切る**:
  - 画面全体を再ビルドせず、変化する部分だけを別の Widget (Consumer) に切り出します。

## 3. 画像の最適化
モバイルアプリのメモリ使用量の9割は画像です。

- **キャッシュ**: `cached_network_image` などを使い、一度DLした画像は保存する。
- **リサイズ**: 100x100で表示する場所に、4000x3000の原寸画像を読み込まない。`cacheWidth`, `cacheHeight` を指定して、メモリに乗せる時点で縮小する。

## 4. ListView の最適化
数千件のリストを表示する場合。

- `ListView` (悪い例): 画面外のアイテムも全て作ってしまう。メモリ不足になる。
- `ListView.builder` (良い例): **画面に見えている分だけ** インスタンス化する。スクロールすると使い回される。

## 5. Impeller (インペラー)
Flutter の新しい描画エンジンです。
従来の Skia エンジンで問題だった「シェーダーコンパイルによるJank（初回アニメーション時のカクつき）」を解消するために開発されました。
iOSではデフォルト有効、Androidでもプレビュー中です。これにより、ネイティブ同等のヌルヌル動作が実現されています。

---

## 📚 用語集 (Glossary)

| 用語 | 意味 | 関連 |
|------|------|-----|
| **DevTools** | 開発者ツール | パフォーマンス計測の必需品 |
| **Jank (ジャンク)** | カクつき、コマ落ち | 16msルールを破ると起きる |
| **16msルール** | 1フレームにかける制限時間 | 1000ms / 60fps = 16.6ms |
| **Impeller** | 新しいレンダリングエンジン | 早い、ヌルヌル |
| **Skia** | 古いレンダリングエンジン | これまでありがとう |
| **RepaintBoundary** | 再描画の壁 | ここから下だけ描き直す、を指定するWidget |

## 🛠️ コマンド集 (Performance)

| コマンド | 説明 |
|---|---|
| `flutter run --profile` | プロファイルモードで起動 | パフォーマンス計測時は必ずこれ！(Debugモードは遅いので参考にならない) |
| `DevTools (Open in Browser)` | VSCodeから起動 | 詳細なグラフが見れる |
