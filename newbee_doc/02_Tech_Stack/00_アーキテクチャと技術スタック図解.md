# 00_アーキテクチャと技術スタック図解 🏗️

TASUKIアプリがどのような技術で動いているのか、その全体像と役割分担を解説します。

## 1. 全体アーキテクチャ図

```mermaid
graph TD
    User((ユーザー)) -->|操作| Flutter[📱 Flutter App (Frontend)]

    subgraph "Frontend (Client)"
        Flutter
        Riverpod[State Management]
        Dio[HTTP Client]
    end

    Flutter -->|API Request| S_Edge[⚡️ Supabase Edge Functions]
    Flutter -->|Data Sync| S_DB[(🗄️ PostgreSQL)]
    Flutter -->|Auth| S_Auth[🔐 Supabase Auth]
    Flutter -->|Video Upload| Mux_API[🎥 Mux API]

    subgraph "Backend (Supabase)"
        S_Auth
        S_DB
        S_Edge
        S_Storage[🗂️ Storage]
    end

    subgraph "AI & Video Services"
        Mux_API -->|WebHook| S_Edge
        S_Edge -->|Analysis| Gemini[🤖 Google Gemini AI]
        Mux_Stream[📺 Mux Streaming]
    end

    Mux_Stream -.->|HLS Stream| Flutter
```

---

## 2. 技術スタックの役割詳細

### 📱 Frontend: Flutter (フラッター)
ユーザーが触れる「画面」と「動き」を作ります。
iOS / Android / Web を一つのコードで生成できるクロスプラットフォームフレームワークです。

- **役割**: UI描画、ユーザー入力の受け付け、カメラ撮影、API通信。
- **重要ライブラリ**:
  - `flutter_riverpod`: 状態管理（データの流れを整理する）。
  - `dio`: 通信（サーバーにリクエストを送る）。
  - `go_router`: 画面遷移（ページ移動）。

### ☁️ Backend: Supabase (スパベース)
「サーバーサイド開発」のすべてを担うプラットフォーム (BaaS) です。

- **🔐 Authentication (認証)**:
  - ユーザー登録、ログイン管理。TASUKIでは「マジックリンク（メール）」を使用。
- **🗄️ PostgreSQL (データベース)**:
  - アプリの心臓部。顧客データや動画のメタデータを保存。
  - **RLS (Row Level Security)**: 「自分のデータしか見れない」というセキュリティルールをDB側で強制します。
- **⚡️ Edge Functions (エッジファンクション)**:
  - サーバー側で実行したいプログラム。
  - 例：「動画がアップロードされたらGeminiに解析依頼を出す」などの自動処理。TypeScriptで記述。
- **🗂️ Storage (ストレージ)**:
  - 画像やファイルの保存場所。

### 🎥 Video: Mux (マックス)
動画の専門家です。動画はデータサイズが巨大で扱いが難しいため、専門のサービスに任せます。

- **役割**:
  - **Encoding**: アップロードされた動画を、スマホでもPCでも再生しやすい形式に変換。
  - **Streaming**: YouTubeのように、スムーズに動画を配信 (HLS形式)。
  - **Thumbnail**: 動画からサムネイル画像を自動生成。

### 🤖 AI: Google Gemini (ジェミニ)
Googleが開発した最新のマルチモーダルAIです。

- **役割**:
  - **動画解析**: Muxに上がった動画の中身を見て、「何が映っているか」「接客態度はどうか」をテキストで説明してくれます。
  - **Speech-to-Text**: 音声を文字に起こします。

---

## 3. なぜこの構成なのか？

### ✅ 開発スピード最優先
Supabaseを使うことで、APIサーバーを一から作る手間を省きました。SQLを書くだけでセキュアなAPIが完成します。

### ✅ スケーラビリティ
Edge Functions や Mux は「サーバーレス」です。ユーザーが1人でも100万人でも、勝手にサーバーが増えて対応してくれます。

### ✅ AIネイティブ
最初から動画解析を前提に設計されており、Edge Functions を介してスムーズにAIと連携できます。

---

## 📚 用語集 (Glossary)

| 用語 | 意味 | イメージ |
|------|------|-----|
| **Frontend** | フロントエンド | お店の接客係（Flutter） |
| **Backend** | バックエンド | お店の調理場（Supabase） |
| **BaaS** | Backend as a Service | 調理場レンタルサービス |
| **HLS** | HTTP Live Streaming | 動画を細切れにして配る技術 |
| **Multimodal** | マルチモーダル | 文字、画像、動画を同時に理解できるAI |
| **Webhook** | ウェブフック | 「終わったよ！」という通知電話 |

