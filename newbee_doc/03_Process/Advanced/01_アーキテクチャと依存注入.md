# 実践プロセス上級編: クリーンアーキテクチャと依存性の注入 🏛️

TASUKI のコードベースは、単なるファイルの集まりではありません。
**「関心事の分離 (Separation of Concerns)」** という原則に基づいて設計されています。

## 1. 3つのレイヤー (Layers)

コードは大きく3つの層に分かれています。外側に行けば行くほど、フレームワーク（FlutterやDB）に依存します。

### Domain / Application Layer (中心)
- **何をする場所？**: アプリの「ルール」や「ビジネスロジック」を書く場所。
- **依存**: FlutterのUIや、特定のDB製品（Supabaseなど）に**極力依存しない**。
- **例**: `VideoService` (動画をアップロードするという行為そのもの), `AuthNotifier` (ログイン状態の管理)。

### Data Layer (外側・下)
- **何をする場所？**: データの保存、取得、通信の具体的な実装。
- **依存**: Supabase SDK, Isar, Http Client など。
- **例**: `SupabaseRepository`, `IsarQueueDatasource`.

### Presentation Layer (外側・上)
- **何をする場所？**: 画面の表示、ユーザー操作の受け付け。
- **依存**: Flutter Widget, Material Design.
- **例**: `RecordScreen`, `TimelineScreen`.

> **ルール**: Presentation層 は Data層 を直接触ってはいけない。必ず Application層 (Service/Notifier) を通して操作する。

## 2. 依存性の注入 (Dependency Injection - DI)
「クラスの中で `new ClassB()` をしない」というのがDIの基本です。

### なぜ `new` してはいけないの？
```dart
class VideoService {
  // 悪い例: ここで具体的な実装を決めてしまっている
  final supabase = SupabaseClient('url', 'key');
}
```
これだと、
1. テスト時に「本物のSupabase」に接続しようとしてしまう。
2. オフラインモード用の「偽物のSupabase」に差し替えることができない。

### DI を使うと
```dart
class VideoService {
  final SupabaseClient client;
  // 良い例: 誰か(Provider)が渡してくれるのを待つ
  VideoService(this.client);
}
```
コードの外側（`providers.dart`）で、「本番なら本物のクライアント」「テストならモック」を注入（Inject）するように制御できます。

## 3. 実際の開発フロー
1. **Data層を作る**: `UploadQueue` など、データの形を決める。
2. **Application層を作る**: `VideoService` など、「何をしたいか」をメソッドにする。
3. **DIを設定する**: `providers.dart` で、Service が必要なものを用意する。
4. **Presentation層を作る**: 画面を作り、`ref.read(videoServiceProvider)` でロジックを呼び出す。

いきなり画面（UI）から作り始めるとロジックが画面に漏れ出すので、**「コア（データ・ロジック）から外側へ」** 作るのが上級者のアプローチです。

---

## 📚 用語集 (Glossary)

| 用語 | 意味 | イメージ |
|------|------|-----|
| **Architecture (アーキテクチャ)** | 構造・設計思想 | 建物の骨組み |
| **Layer (レイヤー)** | 層 | ケーキの層。混ざらないようにする |
| **Separation of Concerns** | 関心事の分離 | 「UI係」と「DB係」を分けること |
| **Application Layer** | アプリの本質 | ロジックの司令塔 |
| **Data Layer** | データの倉庫 | APIやDBへのアクセス担当 |
| **Presentation Layer** | 見た目 | UI担当 |
| **Dependency Injection** | 依存性の注入 | 部品を外から渡してもらう |
| **Tight Coupling (密結合)** | べったり依存 | 分離できない・テストできない |
| **Loose Coupling (疎結合)** | ゆるふわな依存 | 差し替え可能・テストしやすい |

