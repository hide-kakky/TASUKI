# 05_Dockerネットワークとデータ永続化 💾

コンテナは使い捨てですが、データ（DBの中身など）は消えては困ります。
また、コンテナ同士（アプリとDB）はどうやって会話しているのでしょうか？

## 1. データ永続化 (Volume)
コンテナ(`rm`)を消すと、コンテナ内のデータも全部消えます。
これを防ぐために、ホストマシン（あなたのPC）のディスクの一部を、コンテナにマウント（直結）します。

### Docker Compose での書き方
```yaml
services:
  db:
    image: postgres
    volumes:
      - ./pgdata:/var/lib/postgresql/data
```
これで、DBコンテナがデータを書き込む `/var/lib/postgresql/data` は、実はあなたのPCの `./pgdata` フォルダになります。
コンテナを爆破しても、手元のフォルダにデータが残っているので復活できます。

## 2. ネットワーク (Network)
Docker Compose を使うと、自動的に「仮想的なWi-Fi」が作られ、コンテナたちはそこに参加します。

### サービス名がドメインになる
同じ `docker-compose.yaml` に書かれたサービス同士は、**サービス名** で通信できます。

- アプリからDBに接続するとき:
  - ❌ `localhost:5432` （これはコンテナ自身＝アプリ自身を指してしまう）
  - ⭕ `db:5432` （Compose上のサービス名 `db` を指定）

「localhost」は「自分自身」という意味です。Dockerの中では「自分＝そのコンテナ」なので注意しましょう。

## 3. ポートフォワーディング (ports)
コンテナの中のポートを、外（あなたのPC）からアクセスできるように穴を開けることです。

```yaml
ports:
  - "8080:80" # ホストの8080番 -> コンテナの80番
```
これを設定しないと、あなたのブラウザ(`localhost:8080`)からコンテナ内のWebサーバーに繋がりません。
逆に、コンテナ間通信だけなら、ports設定は不要です（内部ネットワークで繋がるから）。

---

## 📚 用語集 (Glossary)

| 用語 | 意味 | 補足 |
|------|------|-----|
| **Volume (ボリューム)** | データの保存場所 | コンテナ外にある「外付けHDD」のようなもの |
| **Mount (マウント)** | ドッキング | ホストのディレクトリをコンテナ内に接続すること |
| **Network** | 仮想ネットワーク | コンテナ同士が会話するためのLAN |
| **Service Discovery** | サービス検出 | 名前(`db`)だけでIPアドレスがわかる仕組み(DNS) |
| **Persistence** | 永続化 | 消えても大丈夫なように保存すること |

## 🛠️ コマンド集 (Volume & Network)

| コマンド | 説明 |
|---|---|
| `docker volume ls` | 作成されたボリュームの一覧 |
| `docker volume inspect [name]` | ボリュームの詳細（保存場所など）を確認 |
| `docker network ls` | ネットワークの一覧 |
| `docker network inspect [name]` | ネットワークの詳細（参加しているコンテナなど）を確認 |
